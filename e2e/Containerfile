# E2E Test Container
# Fully self-contained environment with:
# - systemd + journald (log source)
# - systemd-journal-gatewayd (HTTP API for journal)
# - OpenTelemetry Collector (real OTLP receiver -> file)
# - The forwarder binary
#
# Build with:
#   podman build -f e2e/Containerfile --build-arg DISTRO=fedora -t e2e-fedora .
#   podman build -f e2e/Containerfile --build-arg DISTRO=al2023 -t e2e-al2023 .
#   podman build -f e2e/Containerfile --build-arg DISTRO=debian -t e2e-debian .
#
# Run with: podman run --rm --privileged <image>

ARG DISTRO=fedora

# Base images for each distro
FROM registry.fedoraproject.org/fedora:41 AS base-fedora
FROM public.ecr.aws/amazonlinux/amazonlinux:2023 AS base-al2023
FROM docker.io/library/debian:bookworm AS base-debian

# Select the appropriate base image
FROM base-${DISTRO} AS builder

ARG DISTRO
ARG OTEL_VERSION=0.115.0

# Add rustup's cargo to PATH (for distros that use rustup like Debian)
ENV PATH="/root/.cargo/bin:${PATH}"

# Copy and run distro-specific install script
COPY e2e/distros/${DISTRO}.sh /tmp/install-deps.sh
RUN chmod +x /tmp/install-deps.sh && /tmp/install-deps.sh

# Install OpenTelemetry Collector
RUN curl -fsSL "https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v${OTEL_VERSION}/otelcol_${OTEL_VERSION}_linux_amd64.tar.gz" \
    | tar -xz -C /usr/local/bin otelcol

# Create directories
RUN mkdir -p /app /var/lib/otel-journal-gatewayd-forwarder /test-results

WORKDIR /app

# Copy source code
COPY Cargo.toml Cargo.lock ./
COPY src ./src

# Build the forwarder in release mode
RUN cargo build --release && \
    cp target/release/otel-journal-gatewayd-forwarder /usr/local/bin/ && \
    cargo clean

# Copy e2e test files
COPY e2e/*.sh e2e/*.toml e2e/*.yaml e2e/*.service /app/e2e/
RUN chmod +x /app/e2e/*.sh

# Configure systemd-journal-gatewayd to listen on port 19531
RUN mkdir -p /etc/systemd/system/systemd-journal-gatewayd.socket.d && \
    printf '[Socket]\nListenStream=\nListenStream=19531\n' > /etc/systemd/system/systemd-journal-gatewayd.socket.d/override.conf

# Install systemd services
RUN cp /app/e2e/test-log-generator.service /etc/systemd/system/ && \
    cp /app/e2e/otel-collector.service /etc/systemd/system/ && \
    cp /app/e2e/e2e-test.service /etc/systemd/system/

# Enable services (but NOT e2e-test - that runs via podman exec)
RUN systemctl enable systemd-journal-gatewayd.socket && \
    systemctl enable test-log-generator.service && \
    systemctl enable otel-collector.service

CMD ["/sbin/init"]
